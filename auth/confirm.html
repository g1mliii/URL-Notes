---
layout: default
title: "Confirming..."
scripts:
  - config.js
  - js/lib/encryption.js
  - js/lib/api.js
  - js/app.js
  - js/auth.js
  - js/monitoring.js
---
<div class="app-container">
    <!-- Navigation Header -->
    <header class="nav-header">
        <div class="nav-content">
            <div class="logo">
                <img src="/anchore wout background 512x512.png" alt="Anchored" class="logo-icon">
                <h1>Anchored</h1>
            </div>
        </div>
    </header>

    <!-- Confirmation Content -->
    <main class="confirmation-main">
        <div class="confirmation-container">
            <div id="confirmationStatus" class="confirmation-status">
                <div class="loading-spinner">‚è≥</div>
                <h2>Confirming your account...</h2>
                <p>Please wait while we verify your email.</p>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const tokenHash = urlParams.get('token_hash');
    const type = urlParams.get('type');
    const statusDiv = document.getElementById('confirmationStatus');
    
    if (!tokenHash || !type) {
        statusDiv.innerHTML = `
            <div class="error-message">
                <h2>‚ùå Invalid confirmation link</h2>
                <p>This confirmation link is invalid or expired.</p>
                <a href="/" class="btn-primary">Return to Home</a>
            </div>
        `;
        return;
    }

    try {
        // Wait for auth module to be ready
        if (!window.auth || !window.auth.supabaseClient) {
            await new Promise(resolve => {
                const checkAuth = () => {
                    if (window.auth && window.auth.supabaseClient) {
                        resolve();
                    } else {
                        setTimeout(checkAuth, 100);
                    }
                };
                checkAuth();
            });
        }

        console.log('üîç Confirming with token_hash:', tokenHash, 'type:', type);

        // Verify the OTP token
        const { data, error } = await window.auth.supabaseClient.verifyOtp({
            token_hash: tokenHash,
            type: type
        });

        if (error) {
            throw error;
        }

        console.log('‚úÖ Email confirmation successful:', data);

        // Show success message
        statusDiv.innerHTML = `
            <div class="success-message">
                <h2>‚úÖ Email confirmed successfully!</h2>
                <p>Your account has been verified. Redirecting to dashboard...</p>
            </div>
        `;

        // Redirect to dashboard after short delay
        setTimeout(() => {
            window.location.href = '/dashboard';
        }, 2000);

    } catch (error) {
        console.error('‚ùå Email confirmation failed:', error);
        
        let errorMessage = 'Email confirmation failed. Please try again.';
        if (error.message) {
            const errorMsg = error.message.toLowerCase();
            if (errorMsg.includes('expired') || errorMsg.includes('invalid')) {
                errorMessage = 'This confirmation link has expired. Please request a new one.';
            } else if (errorMsg.includes('already confirmed')) {
                errorMessage = 'This email has already been confirmed. You can sign in now.';
            }
        }

        statusDiv.innerHTML = `
            <div class="error-message">
                <h2>‚ùå Confirmation failed</h2>
                <p>${errorMessage}</p>
                <a href="/" class="btn-primary">Return to Home</a>
            </div>
        `;
    }
});
</script>

<style>
.confirmation-main {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 60vh;
    padding: 2rem;
}

.confirmation-container {
    max-width: 500px;
    width: 100%;
    text-align: center;
}

.confirmation-status {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 2rem;
    backdrop-filter: blur(10px);
    box-shadow: var(--glass-shadow);
}

.loading-spinner {
    font-size: 2rem;
    margin-bottom: 1rem;
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.success-message {
    color: var(--success-color, #28a745);
}

.error-message {
    color: var(--error-color, #dc3545);
}

.btn-primary {
    display: inline-block;
    margin-top: 1rem;
    padding: 0.75rem 1.5rem;
    background: var(--accent-primary);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    transition: background-color 0.2s;
}

.btn-primary:hover {
    background: var(--accent-primary-hover);
}
</style>