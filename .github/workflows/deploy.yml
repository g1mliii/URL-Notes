# GitHub Pages Deployment for Anchored Web Application
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Enable GitHub Pages via API
        run: |
          # First, try to create/enable Pages with GitHub Actions source
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/pages \
            -d '{
              "source": {
                "branch": "main",
                "path": "/"
              },
              "build_type": "workflow"
            }' || echo "Pages may already be enabled, continuing..."
          
          # Wait a moment for the API to process
          sleep 5
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Build web application
        run: |
          # Create build directory
          mkdir -p _site
          
          # Copy web application files to build directory
          cp -r web-app/* _site/
          
          # Ensure HTTPS is enforced in production
          echo "Configuring for HTTPS deployment..."
          
          # Create .nojekyll file to prevent Jekyll processing
          touch _site/.nojekyll
          
          # Ensure CNAME file is present for custom domain
          echo "anchored.site" > _site/CNAME
          
          # Create robots.txt for SEO
          cat > _site/robots.txt << EOF
          User-agent: *
          Allow: /
          
          Sitemap: https://anchored.site/sitemap.xml
          EOF
          
          # Create basic sitemap.xml
          cat > _site/sitemap.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://anchored.site/</loc>
              <lastmod>$(date -u +%Y-%m-%d)</lastmod>
              <changefreq>weekly</changefreq>
              <priority>1.0</priority>
            </url>
            <url>
              <loc>https://anchored.site/dashboard.html</loc>
              <lastmod>$(date -u +%Y-%m-%d)</lastmod>
              <changefreq>daily</changefreq>
              <priority>0.8</priority>
            </url>
            <url>
              <loc>https://anchored.site/account.html</loc>
              <lastmod>$(date -u +%Y-%m-%d)</lastmod>
              <changefreq>monthly</changefreq>
              <priority>0.6</priority>
            </url>
          </urlset>
          EOF
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4