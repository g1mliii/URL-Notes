# Implementation Plan

- [x] 1. Set up project structure and core infrastructure
  - Create web application directory structure with HTML, CSS, and JS folders
  - Set up basic HTML templates for landing, dashboard, and account pages with Anchored branding
  - Create main.css with ocean-themed glassmorphism design tokens matching extension styles
  - Implement responsive breakpoints for mobile-first design
  - Apply dark blue ocean anchor theme throughout the application
  - _Requirements: 9.1, 9.2, 9.3_
- [ ] 2. Adapt core libraries from extension for web environment
  - [x] 2.1 Port encryption.js library for web application
    - Copy encryption.js from extension and adapt for web environment (remove Chrome APIs)
    - Test encryption/decryption functionality in browser environment
    - Ensure compatibility with existing extension encryption format
    - _Requirements: 11.1, 10.1_
  - [x] 2.2 Adapt api.js for web application authentication
    - Copy and modify api.js to work without Chrome extension APIs
    - Implement web-based localStorage/sessionStorage instead of chrome.storage.local
    - Adapt authentication methods for web environment
    - _Requirements: 11.3, 1.2, 2.2_
  - [x] 2.3 Create simplified storage adapter for web
    - Create ultra-aggressive caching storage adapter (cache-first, API-minimal)
    - Implement localStorage-based caching with 24+ hour cache duration
    - Batch API saves: only sync after 10+ changes, 30+ minutes, or tab close
    - Use emergency sync on beforeunload, batch queue for multiple notes
    - Load from cache immediately, fetch from API only once per day
    - No IndexedDB complexity - just localStorage cache + smart cloud sync
    - _Requirements: 11.2_
  - [x] 2.4 Port export-formats.js for web downloads
    - Copy export-formats.js and adapt for web file downloads
    - Implement browser-based file download functionality
    - Test all export formats (JSON, Markdown, Obsidian, Notion, Plain Text, Google Docs)
    - _Requirements: 11.5, 7.1_
- [x] 3. Adapt existing authentication system for web
  - [x] 3.1 Port authentication UI from extension
    - Copy authentication forms and validation from extension settings.js
    - Adapt handleSignUp(), handleSignIn(), and handleForgotPassword() methods for web
    - Reuse existing Supabase Auth integration from api.js
    - Ensure encryption key generation works the same as extension
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_
  - [x] 3.2 Implement web-specific authentication flow
    - Adapt session management for web environment (localStorage instead of chrome.storage)
    - Handle authentication success and redirect to dashboard
    - Implement password reset flow with existing resetPassword() method
    - Add encryption key migration for password changes (reuse extension logic)
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 10.1, 10.2_
- [x] 4. Build notes dashboard interface
  - [x] 4.1 Create notes display and organization system
    - Build notes dashboard layout with domain/URL organization
    - Implement note cards with preview functionality (read-only focus)
    - Add domain and URL filtering capabilities
    - Create search functionality across note content
    - Focus on note management, viewing, and organization rather than intensive editing
    - _Requirements: 6.1, 6.2, 11.4_
  - [x] 4.2 Implement simplified note editing functionality
    - Create basic note editor interface with auto-save on blur/close
    - Integrate with encryption for secure note storage
    - Implement direct cloud sync (no local storage complexity)
    - Add note deletion functionality with confirmation
    - Focus on note management rather than full editing experience
    - _Requirements: 6.3, 6.4, 6.5_
- [ ] 5. Deploy website to production
  - [x] 5.1 Configure production environment and GitHub Pages hosting

    - Set up automated deployment from main branch
    - Configure environment variables and build process if needed
    - Ensure HTTPS is enabled through GitHub Pages
    - _Requirements: Security and performance requirements_
  - [x] 5.2 Deploy and monitor application
    - ✅ Deploy application to production environment
    - ✅ Update Supabase configuration for production domain
    - ✅ Set up monitoring and error tracking
    - ✅ Configure backup and disaster recovery
    - ✅ Perform final production testing and validation
    **Completion Summary:**
    - ✅ Production deployment live at https://anchored.site
    - ✅ Direct GitHub Pages deployment from URL-Notes repository
    - ✅ All files accessible: config.js, health.json, monitoring.js
    - ✅ All pages functional: landing, dashboard, account
    - ✅ Client-side monitoring and error tracking implemented
    - ✅ Security headers configured via HTML meta tags
    - ✅ Backup and disaster recovery plan documented
    - ✅ HTTPS enforced with valid SSL certificate
    - ✅ Simplified deployment process (no cross-repository complexity)
    **Deployment Method:**
    - Direct GitHub Pages from main branch, root folder
    - Custom domain: anchored.site
    - Instant updates on push to main branch
    - Drag-and-drop file editing supported
    - _Requirements: All requirements in production environment_
- [x] 6. Implement subscription management system
  - [x] 6.1 Create subscription upgrade interface
    - Build premium plan selection interface with $2.50/month pricing
    - Integrate Stripe  payment processing for monthly subscriptions
    - Create edge function for subscription status updates
    - create upgrade fucntion and end of subcscription for already existing users and thier ai usage to 500 and back to 5, 
    - Handle successful payment and account activation
    - Display clear free vs premium feature comparison
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  - [x] 6.2 Build subscription management dashboard
    - Display current subscription status and details using stripe integraion
    - Implement payment method update functionality using strip integration
    - Add subscription cancellation with expiration handling using stripe integration 
    - Create billing history and invoice access using stripe integration
    - _Requirements: 5.1, 5.2, 5.3, 5.4_
- [x] 8. ~~Standardize encryption~~ (COMPLETE - Both platforms already use identical encryption)
  - [x] 8.1 ~~Update web app encryption~~ (COMPLETE - Already uses `user.id:user.email + salt`)
  - [x] 8.2 ~~Verify extension encryption~~ (COMPLETE - Already uses `user.id:user.email + salt`)
  - **Status**: Both extension and web app use identical key derivation: `PBKDF2(user.id:user.email, salt, 100000 iterations)`
  - **Verified**: Same encryption logic, same salt storage, full compatibility
  - _Requirements: 10.1, 11.1, 3.4, 10.2 - All satisfied_
- [x] 9. Complete password reset functionality implementation 
  - [x] 9.1 Configure password reset redirect and callback handling
    - Configure Supabase Auth redirect URL to point to anchored.site password reset page
    - Create password reset callback handler to process email link parameters
    - Build password reset form interface for entering new password
    - Implement Supabase Auth password update using access token from email link
    - Test complete forgot password → email → reset → login flow
    - _Requirements: 3.1, 3.2, 3.3, 3.4_
  - [x] 9.2 Handle password reset edge cases and user experience
    - Add proper error handling for invalid/expired reset tokens
    - Add user feedback for successful reset email sending
    - Ensure proper redirect flow after successful password reset
    - Add loading states and success/error messages
    - Note: No encryption migration needed with email-based keys
    - _Requirements: 3.5_
- [x] 10. Implement export functionality build from same code as extension export since they should behave the same way
  - [x] 10.1 Create export interface with note selection build from same code as extension export since they should behave the same way mostly with some additiona features in webpage
    - Build export modal with format selection dropdown
    - Implement individual note selection with checkboxes
    - Add bulk selection options by domain/URL
    - Create progress indicators for export processing
    - also fix the domain and datefilter from looking differnet in dashboard for mac os safari webpage not mobile, verion style is not the same as other browsers.
    - _Requirements: 7.1, 7.2, 7.4_
  - [x] 10.2 Implement export processing and download
    - implement actual export functionality similir to extension export since file structur should be similar,
    - Generate export files using adapted export-formats.js
    - Implement browser file download functionality
    - Handle export errors with retry options
    - _Requirements: 7.3, 7.5_
- [x] 11 Implement import functionality i dont think our extension encrypts on import so we can just import normal and when syncs it should encrypt just like extenion unless our wepbage behaves differntl
    - Build file upload interface with format validation
    - Support JSON imports rename export and import from json to anchored so user doenst get confused.
    - Implement file parsing and validation
    - Display import preview before processing
    - _Requirements: 8.1, 8.2_


- [x] 15 Implement XSS prevention for web application (CRITICAL - DO FIRST)
  - Install and integrate DOMPurify library for content sanitization in web app
  - Replace all innerHTML usage in web app with safe DOM manipulation methods
  - Implement Content Security Policy (CSP) headers for web application
  - Add comprehensive input validation for note content, titles, and tags in web app
  - **WEB APP FOCUS**: Simple contenteditable with basic formatting - fewer features to preserve
  - Preserve core web app functionality:
    - Basic contenteditable behavior and cursor positioning
    - Simple link handling and external link opening
    - Auto-save functionality during editing
    - Note display and rendering in dashboard
    - Import/export functionality
  - Configure DOMPurify to allow safe HTML tags needed for basic rich text
  - Test XSS prevention with malicious payloads in web app
  - Validate that note import/export maintains formatting after sanitization
  - **GOAL**: Prove XSS prevention approach works before tackling complex extension
  - _Requirements: Web application security and data protection requirements_

- [x] 15.1 Implement XSS prevention for extension (CRITICAL - DO AFTER WEB APP)
  - Apply lessons learned from web app XSS prevention to extension
  - Install and integrate DOMPurify library for content sanitization in extension
  - Replace all innerHTML usage in extension with safe DOM manipulation methods
  - Add comprehensive input validation for note content, titles, and tags in extension
  - **EXTENSION COMPLEXITY**: Rich text editor with advanced features - requires careful preservation of:
    - Rich text formatting toolbar (bold, italic, underline, strikethrough)
    - Markdown conversion (bidirectional HTML ↔ Markdown)
    - Advanced paste handling and existing sanitization logic
    - Citation and color formatting features
    - Nested formatting combinations (bold + italic, etc.)
    - Context menu operations and keyboard shortcuts
    - Complex contenteditable behavior and cursor positioning
  - Configure DOMPurify to allow safe HTML tags needed for rich text editing
  - Test XSS prevention with malicious payloads while ensuring ALL editor features work
  - Validate that note import/export maintains complex formatting after sanitization
  - **GOAL**: Secure extension without breaking any rich text functionality
  - _Requirements: Extension security and data protection requirements while maintaining full UX_

- [ ] 15.2 Implement HTTP-only cookie authentication for web app (WEB APP ONLY)
  - **Create Supabase Edge Functions** for secure cookie-based authentication (NO JWT/AUTH REQUIRED)
    - `auth-login`: Handle login and set HTTP-only refresh token cookie (public endpoint - no auth required)
    - `auth-refresh`: Refresh access token using HTTP-only cookie (uses cookie for auth, not JWT header)
    - `auth-logout`: Clear HTTP-only cookies and invalidate tokens (uses cookie for auth, not JWT header)
  - **Replace localStorage token storage** with HTTP-only cookies
    - Remove all localStorage token storage code from web app
    - Store refresh tokens in HTTP-only, Secure, SameSite cookies
    - Keep access tokens in memory only (short-lived, 15-30 minutes)
    - Automatic cookie handling by browser (no manual storage code needed)
  - **Configure cookie security settings**
    - HttpOnly: Prevent JavaScript access (XSS protection)
    - Secure: HTTPS only transmission
    - SameSite=Strict: CSRF protection
    - Appropriate Max-Age for refresh tokens
  - **Update web app authentication flow**
    - Route all auth through Edge Functions instead of direct Supabase calls
    - Use `credentials: 'include'` for automatic cookie handling
    - Implement automatic token refresh before expiration
    - Handle cookie-based session validation
  - **Device fingerprinting for token binding** (both platforms)
    - Bind tokens to device characteristics to prevent session hijacking
    - Extension: Add to existing chrome.storage.local implementation
    - Web app: Integrate with Edge Function cookie validation
  - **Clean up old token management code**
    - Remove localStorage encryption/decryption logic
    - Remove session management complexity
    - Simplify authentication state handling
  - **NOTE**: Extension keeps current chrome.storage.local (already secure), only adds device binding
  - _Requirements: Secure web app authentication with simplified token management_

- [ ] 15.3.3 Test and validate HTTP-only cookie implementation (WEB APP ONLY)
  - **Cross-browser compatibility testing**
    - Desktop browsers: Chrome, Safari, Firefox, Edge
    - Mobile browsers: iOS Safari, Android Chrome
    - Private/incognito browsing mode compatibility
    - Cookie persistence across browser sessions
  - **Security validation testing**
    - Verify HTTP-only cookies cannot be accessed via JavaScript
    - Test XSS attack scenarios (cookies should be protected)
    - Validate CSRF protection with SameSite settings
    - Test token refresh flow and automatic cookie handling
  - **Edge Function testing**
    - Test authentication Edge Functions under load
    - Validate cookie setting and clearing functionality
    - Test error handling and fallback scenarios
    - Verify CORS configuration for cookie handling
  - **Migration and cleanup**
    - Migrate existing localStorage sessions to cookie-based auth
    - Clean up old localStorage data and encryption code
    - Remove unused session management utilities
    - Update documentation and authentication flow diagrams
  - **Performance and reliability testing**
    - Test authentication flow performance vs old localStorage approach
    - Validate session persistence across mobile app switching
    - Test network failure scenarios and recovery
    - Verify automatic token refresh reliability
  - **NOTE**: Extension testing only needs device binding validation
  - _Requirements: Comprehensive validation of simplified cookie-based authentication_

- [ ] 17. implement retry mechanism for encrypted notes in our extension so that when we have placeholder content and then the encryption key is recieved it unencrypts and fixes the note, for example if sync issue happens and note gets placeholder content, add flag and retry method so it get unencrypted with the key and refresht the notes view so the updated versoin shows up.
     -also make sure if placeholder content is there sync cannot happen for those notes as otherwise theyu will overwrite the notes in the /database with paceholder.


- [x] 16. implement planned migraton in stripe migration plan and produt analysis 


  **✅ MIGRATION COMPLETED**
  - ✅ Updated config.js with predefined Stripe product configuration
  - ✅ Migrated subscription-api function from price_data to predefined price ID
  - ✅ Migrated subscription-management function to use same predefined price ID
  - ✅ Enhanced logging to show product and price ID usage
  - ✅ Added fallback price ID for environment variable
  
  **Implementation Details:**
  - Stripe product key: prod_T2kES07o4K6Gzk
  - Stripe price ID: price_1S6ek9AmZvKSDgI488vHQ0Tq
  - Environment variable: STRIPE_PREMIUM_PRICE_ID (with fallback)
  - No breaking changes to existing subscriptions
  - Professional Stripe product setup for better analytics and management
